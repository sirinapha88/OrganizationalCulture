
// Raw
// -------
'use strict';

exports.__esModule = true;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _inherits = require('inherits');

var _inherits2 = _interopRequireDefault(_inherits);

var _events = require('events');

var _lodash = require('lodash');

function Raw(client) {
  this.client = client;

  this.sql = '';
  this.bindings = [];
  this._cached = undefined;

  // Todo: Deprecate
  this._wrappedBefore = undefined;
  this._wrappedAfter = undefined;
  this._debug = client && client.config && client.config.debug;
}
_inherits2['default'](Raw, _events.EventEmitter);

_lodash.assign(Raw.prototype, {

  set: function set(sql, bindings) {
    this._cached = undefined;
    this.sql = sql;
    this.bindings = _lodash.isObject(bindings) || _lodash.isUndefined(bindings) ? bindings : [bindings];

    return this;
  },

  timeout: function timeout(ms) {
    if (_lodash.isNumber(ms) && ms > 0) {
      this._timeout = ms;
    }
    return this;
  },

  // Wraps the current sql with `before` and `after`.
  wrap: function wrap(before, after) {
    this._cached = undefined;
    this._wrappedBefore = before;
    this._wrappedAfter = after;
    return this;
  },

  // Calls `toString` on the Knex object.
  toString: function toString() {
    return this.toQuery();
  },

  // Returns the raw sql for the query.
  toSQL: function toSQL(method, tz) {
    if (this._cached) return this._cached;
    if (Array.isArray(this.bindings)) {
      this._cached = replaceRawArrBindings(this);
    } else if (this.bindings && _lodash.isPlainObject(this.bindings)) {
      this._cached = replaceKeyBindings(this);
    } else {
      this._cached = {
        method: 'raw',
        sql: this.sql,
        bindings: _lodash.isUndefined(this.bindings) ? void 0 : [this.bindings]
      };
    }
    if (this._wrappedBefore) {
      this._cached.sql = this._wrappedBefore + this._cached.sql;
    }
    if (this._wrappedAfter) {
      this._cached.sql = this._cached.sql + this._wrappedAfter;
    }
    this._cached.options = _lodash.reduce(this._options, _lodash.assign, {});
    if (this._timeout) {
      this._cached.timeout = this._timeout;
    }
    if (this.client && this.client.prepBindings) {
      this._cached.bindings = this.client.prepBindings(this._cached.bindings || [], tz);
    }
    return this._cached;
  }

});

function replaceRawArrBindings(raw) {
  var expectedBindings = raw.bindings.length;
  var values = raw.bindings;
  var client = raw.client;

  var index = 0;
  var bindings = [];

  var sql = raw.sql.replace(/\\?\?\??/g, function (match) {
    if (match === '\\?') {
      return match;
    }

    var value = values[index++];

    if (value && typeof value.toSQL === 'function') {
      var bindingSQL = value.toSQL();
      if (bindingSQL.bindings !== undefined) {
        bindings = bindings.concat(bindingSQL.bindings);
      }
      return bindingSQL.sql;
    }

    if (match === '??') {
      return client.formatter().columnize(value);
    }
    bindings.push(value);
    return '?';
  });

  if (expectedBindings !== index) {
    throw new Error('Expected ' + expectedBindings + ' bindings, saw ' + index);
  }

  return {
    method: 'raw',
    sql: sql,
    bindings: bindings
  };
}

function replaceKeyBindings(raw) {
  var values = raw.bindings;
  var client = raw.client;
  var sql = raw.sql;var bindings = [];

  var regex = new RegExp('(\\:\\w+\\:?)', 'g');
  sql = raw.sql.replace(regex, function (full) {
    var key = full.trim();
    var isIdentifier = key[key.length - 1] === ':';
    var value = isIdentifier ? values[key.slice(1, -1)] : values[key.slice(1)];
    if (value === undefined) {
      return full;
    }
    if (value && typeof value.toSQL === 'function') {
      var bindingSQL = value.toSQL();
      if (bindingSQL.bindings !== undefined) {
        bindings = bindings.concat(bindingSQL.bindings);
      }
      return full.replace(key, bindingSQL.sql);
    }
    if (isIdentifier) {
      return full.replace(key, client.formatter().columnize(value));
    }
    bindings.push(value);
    return full.replace(key, '?');
  });

  return {
    method: 'raw',
    sql: sql,
    bindings: bindings
  };
}

// Allow the `Raw` object to be utilized with full access to the relevant
// promise API.
require('./interface')(Raw);

exports['default'] = Raw;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,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QUNiLE9BQUcsRUFBSCxHQUFHO0FBQ0gsWUFBUSxFQUFSLFFBQVE7R0FDVCxDQUFBO0NBQ0Y7Ozs7QUFJRCxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUE7O3FCQUVaLEdBQUciLCJmaWxlIjoicmF3LmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG4vLyBSYXdcbi8vIC0tLS0tLS1cbmltcG9ydCBpbmhlcml0cyBmcm9tICdpbmhlcml0cyc7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuXG5pbXBvcnQgeyBhc3NpZ24sIHJlZHVjZSwgaXNQbGFpbk9iamVjdCwgaXNPYmplY3QsIGlzVW5kZWZpbmVkLCBpc051bWJlciB9IGZyb20gJ2xvZGFzaCdcblxuZnVuY3Rpb24gUmF3KGNsaWVudCkge1xuICB0aGlzLmNsaWVudCA9IGNsaWVudFxuXG4gIHRoaXMuc3FsID0gJydcbiAgdGhpcy5iaW5kaW5ncyA9IFtdXG4gIHRoaXMuX2NhY2hlZCA9IHVuZGVmaW5lZFxuXG4gIC8vIFRvZG86IERlcHJlY2F0ZVxuICB0aGlzLl93cmFwcGVkQmVmb3JlID0gdW5kZWZpbmVkXG4gIHRoaXMuX3dyYXBwZWRBZnRlciA9IHVuZGVmaW5lZFxuICB0aGlzLl9kZWJ1ZyA9IGNsaWVudCAmJiBjbGllbnQuY29uZmlnICYmIGNsaWVudC5jb25maWcuZGVidWdcbn1cbmluaGVyaXRzKFJhdywgRXZlbnRFbWl0dGVyKVxuXG5hc3NpZ24oUmF3LnByb3RvdHlwZSwge1xuXG4gIHNldChzcWwsIGJpbmRpbmdzKSB7XG4gICAgdGhpcy5fY2FjaGVkID0gdW5kZWZpbmVkXG4gICAgdGhpcy5zcWwgPSBzcWxcbiAgICB0aGlzLmJpbmRpbmdzID0gKGlzT2JqZWN0KGJpbmRpbmdzKSB8fCBpc1VuZGVmaW5lZChiaW5kaW5ncykpID8gIGJpbmRpbmdzIDogW2JpbmRpbmdzXVxuXG4gICAgcmV0dXJuIHRoaXNcbiAgfSxcblxuICB0aW1lb3V0KG1zKSB7XG4gICAgaWYoaXNOdW1iZXIobXMpICYmIG1zID4gMCkge1xuICAgICAgdGhpcy5fdGltZW91dCA9IG1zO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfSxcblxuICAvLyBXcmFwcyB0aGUgY3VycmVudCBzcWwgd2l0aCBgYmVmb3JlYCBhbmQgYGFmdGVyYC5cbiAgd3JhcChiZWZvcmUsIGFmdGVyKSB7XG4gICAgdGhpcy5fY2FjaGVkID0gdW5kZWZpbmVkXG4gICAgdGhpcy5fd3JhcHBlZEJlZm9yZSA9IGJlZm9yZVxuICAgIHRoaXMuX3dyYXBwZWRBZnRlciA9IGFmdGVyXG4gICAgcmV0dXJuIHRoaXNcbiAgfSxcblxuICAvLyBDYWxscyBgdG9TdHJpbmdgIG9uIHRoZSBLbmV4IG9iamVjdC5cbiAgdG9TdHJpbmcoKSB7XG4gICAgcmV0dXJuIHRoaXMudG9RdWVyeSgpXG4gIH0sXG5cbiAgLy8gUmV0dXJucyB0aGUgcmF3IHNxbCBmb3IgdGhlIHF1ZXJ5LlxuICB0b1NRTChtZXRob2QsIHR6KSB7XG4gICAgaWYgKHRoaXMuX2NhY2hlZCkgcmV0dXJuIHRoaXMuX2NhY2hlZFxuICAgIGlmIChBcnJheS5pc0FycmF5KHRoaXMuYmluZGluZ3MpKSB7XG4gICAgICB0aGlzLl9jYWNoZWQgPSByZXBsYWNlUmF3QXJyQmluZGluZ3ModGhpcylcbiAgICB9IGVsc2UgaWYgKHRoaXMuYmluZGluZ3MgJiYgaXNQbGFpbk9iamVjdCh0aGlzLmJpbmRpbmdzKSkge1xuICAgICAgdGhpcy5fY2FjaGVkID0gcmVwbGFjZUtleUJpbmRpbmdzKHRoaXMpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2NhY2hlZCA9IHtcbiAgICAgICAgbWV0aG9kOiAncmF3JyxcbiAgICAgICAgc3FsOiB0aGlzLnNxbCxcbiAgICAgICAgYmluZGluZ3M6IGlzVW5kZWZpbmVkKHRoaXMuYmluZGluZ3MpID8gdm9pZCAwIDogW3RoaXMuYmluZGluZ3NdXG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLl93cmFwcGVkQmVmb3JlKSB7XG4gICAgICB0aGlzLl9jYWNoZWQuc3FsID0gdGhpcy5fd3JhcHBlZEJlZm9yZSArIHRoaXMuX2NhY2hlZC5zcWxcbiAgICB9XG4gICAgaWYgKHRoaXMuX3dyYXBwZWRBZnRlcikge1xuICAgICAgdGhpcy5fY2FjaGVkLnNxbCA9IHRoaXMuX2NhY2hlZC5zcWwgKyB0aGlzLl93cmFwcGVkQWZ0ZXJcbiAgICB9XG4gICAgdGhpcy5fY2FjaGVkLm9wdGlvbnMgPSByZWR1Y2UodGhpcy5fb3B0aW9ucywgYXNzaWduLCB7fSlcbiAgICBpZih0aGlzLl90aW1lb3V0KSB7XG4gICAgICB0aGlzLl9jYWNoZWQudGltZW91dCA9IHRoaXMuX3RpbWVvdXQ7XG4gICAgfVxuICAgIGlmKHRoaXMuY2xpZW50ICYmIHRoaXMuY2xpZW50LnByZXBCaW5kaW5ncykge1xuICAgICAgdGhpcy5fY2FjaGVkLmJpbmRpbmdzID0gdGhpcy5jbGllbnQucHJlcEJpbmRpbmdzKHRoaXMuX2NhY2hlZC5iaW5kaW5ncyB8fCBbXSwgdHopO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fY2FjaGVkXG4gIH1cblxufSlcblxuZnVuY3Rpb24gcmVwbGFjZVJhd0FyckJpbmRpbmdzKHJhdykge1xuICBjb25zdCBleHBlY3RlZEJpbmRpbmdzID0gcmF3LmJpbmRpbmdzLmxlbmd0aFxuICBjb25zdCB2YWx1ZXMgPSByYXcuYmluZGluZ3NcbiAgY29uc3QgeyBjbGllbnQgfSA9IHJhd1xuICBsZXQgaW5kZXggPSAwO1xuICBsZXQgYmluZGluZ3MgPSBbXVxuXG4gIGNvbnN0IHNxbCA9IHJhdy5zcWwucmVwbGFjZSgvXFxcXD9cXD9cXD8/L2csIGZ1bmN0aW9uKG1hdGNoKSB7XG4gICAgaWYgKG1hdGNoID09PSAnXFxcXD8nKSB7XG4gICAgICByZXR1cm4gbWF0Y2hcbiAgICB9XG5cbiAgICBjb25zdCB2YWx1ZSA9IHZhbHVlc1tpbmRleCsrXVxuXG4gICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZS50b1NRTCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgY29uc3QgYmluZGluZ1NRTCA9IHZhbHVlLnRvU1FMKClcbiAgICAgIGlmIChiaW5kaW5nU1FMLmJpbmRpbmdzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgYmluZGluZ3MgPSBiaW5kaW5ncy5jb25jYXQoYmluZGluZ1NRTC5iaW5kaW5ncylcbiAgICAgIH1cbiAgICAgIHJldHVybiBiaW5kaW5nU1FMLnNxbFxuICAgIH1cblxuICAgIGlmIChtYXRjaCA9PT0gJz8/Jykge1xuICAgICAgcmV0dXJuIGNsaWVudC5mb3JtYXR0ZXIoKS5jb2x1bW5pemUodmFsdWUpXG4gICAgfVxuICAgIGJpbmRpbmdzLnB1c2godmFsdWUpXG4gICAgcmV0dXJuICc/J1xuICB9KVxuXG4gIGlmIChleHBlY3RlZEJpbmRpbmdzICE9PSBpbmRleCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgJHtleHBlY3RlZEJpbmRpbmdzfSBiaW5kaW5ncywgc2F3ICR7aW5kZXh9YClcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgbWV0aG9kOiAncmF3JyxcbiAgICBzcWwsXG4gICAgYmluZGluZ3NcbiAgfVxufVxuXG5mdW5jdGlvbiByZXBsYWNlS2V5QmluZGluZ3MocmF3KSB7XG4gIGNvbnN0IHZhbHVlcyA9IHJhdy5iaW5kaW5nc1xuICBjb25zdCB7IGNsaWVudCB9ID0gcmF3XG4gIGxldCB7IHNxbCB9ID0gcmF3LCBiaW5kaW5ncyA9IFtdXG5cbiAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKCcoXFxcXDpcXFxcdytcXFxcOj8pJywgJ2cnKVxuICBzcWwgPSByYXcuc3FsLnJlcGxhY2UocmVnZXgsIGZ1bmN0aW9uKGZ1bGwpIHtcbiAgICBjb25zdCBrZXkgPSBmdWxsLnRyaW0oKTtcbiAgICBjb25zdCBpc0lkZW50aWZpZXIgPSBrZXlba2V5Lmxlbmd0aCAtIDFdID09PSAnOidcbiAgICBjb25zdCB2YWx1ZSA9IGlzSWRlbnRpZmllciA/IHZhbHVlc1trZXkuc2xpY2UoMSwgLTEpXSA6IHZhbHVlc1trZXkuc2xpY2UoMSldXG4gICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBmdWxsO1xuICAgIH1cbiAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlLnRvU1FMID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBjb25zdCBiaW5kaW5nU1FMID0gdmFsdWUudG9TUUwoKVxuICAgICAgaWYgKGJpbmRpbmdTUUwuYmluZGluZ3MgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBiaW5kaW5ncyA9IGJpbmRpbmdzLmNvbmNhdChiaW5kaW5nU1FMLmJpbmRpbmdzKVxuICAgICAgfVxuICAgICAgcmV0dXJuIGZ1bGwucmVwbGFjZShrZXksIGJpbmRpbmdTUUwuc3FsKVxuICAgIH1cbiAgICBpZiAoaXNJZGVudGlmaWVyKSB7XG4gICAgICByZXR1cm4gZnVsbC5yZXBsYWNlKGtleSwgY2xpZW50LmZvcm1hdHRlcigpLmNvbHVtbml6ZSh2YWx1ZSkpXG4gICAgfVxuICAgIGJpbmRpbmdzLnB1c2godmFsdWUpXG4gICAgcmV0dXJuIGZ1bGwucmVwbGFjZShrZXksICc/JylcbiAgfSlcblxuICByZXR1cm4ge1xuICAgIG1ldGhvZDogJ3JhdycsXG4gICAgc3FsLFxuICAgIGJpbmRpbmdzXG4gIH1cbn1cblxuLy8gQWxsb3cgdGhlIGBSYXdgIG9iamVjdCB0byBiZSB1dGlsaXplZCB3aXRoIGZ1bGwgYWNjZXNzIHRvIHRoZSByZWxldmFudFxuLy8gcHJvbWlzZSBBUEkuXG5yZXF1aXJlKCcuL2ludGVyZmFjZScpKFJhdylcblxuZXhwb3J0IGRlZmF1bHQgUmF3XG4iXX0=